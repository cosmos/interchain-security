<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v3.3.0 plugin-docs plugin-id-default docs-doc-id-adrs/adr-011-improving-test-confidence">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Improving testing and increasing confidence | Interchain Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cosmos.github.io/interchain-security/legacy/img/banner.jpg"><meta data-rh="true" name="twitter:image" content="https://cosmos.github.io/interchain-security/legacy/img/banner.jpg"><meta data-rh="true" property="og:url" content="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-011-improving-test-confidence"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v3.3.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v3.3.0"><meta data-rh="true" name="docsearch:version" content="v3.3.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v3.3.0"><meta data-rh="true" property="og:title" content="Improving testing and increasing confidence | Interchain Security"><meta data-rh="true" name="description" content="Changelog"><meta data-rh="true" property="og:description" content="Changelog"><link data-rh="true" rel="icon" href="/interchain-security/legacy/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-011-improving-test-confidence"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-011-improving-test-confidence" hreflang="en"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-011-improving-test-confidence" hreflang="x-default"><link rel="stylesheet" href="/interchain-security/legacy/assets/css/styles.f695a4a3.css">
<link rel="preload" href="/interchain-security/legacy/assets/js/runtime~main.6dc179b3.js" as="script">
<link rel="preload" href="/interchain-security/legacy/assets/js/main.206ddac4.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/interchain-security/legacy/"><b class="navbar__title text--truncate">Interchain Security</b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/interchain-security/legacy/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/interchain-security/legacy/">Next</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/">v3.3.1-lsm</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.3.0">v3.3.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.2.0">v3.2.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.1.0">v3.1.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v2.4.0-lsm">v2.4.0-lsm</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v2.0.0">v2.0.0</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cosmos/interchain-security" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="github-icon">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0.300049C5.4 0.300049 0 5.70005 0 12.3001C0 17.6001 3.4 22.1001 8.2 23.7001C8.8 23.8001 9 23.4001 9 23.1001C9 22.8001 9 22.1001 9 21.1001C5.7 21.8001 5 19.5001 5 19.5001C4.5 18.1001 3.7 17.7001 3.7 17.7001C2.5 17.0001 3.7 17.0001 3.7 17.0001C4.9 17.1001 5.5 18.2001 5.5 18.2001C6.6 20.0001 8.3 19.5001 9 19.2001C9.1 18.4001 9.4 17.9001 9.8 17.6001C7.1 17.3001 4.3 16.3001 4.3 11.7001C4.3 10.4001 4.8 9.30005 5.5 8.50005C5.5 8.10005 5 6.90005 5.7 5.30005C5.7 5.30005 6.7 5.00005 9 6.50005C10 6.20005 11 6.10005 12 6.10005C13 6.10005 14 6.20005 15 6.50005C17.3 4.90005 18.3 5.30005 18.3 5.30005C19 7.00005 18.5 8.20005 18.4 8.50005C19.2 9.30005 19.6 10.4001 19.6 11.7001C19.6 16.3001 16.8 17.3001 14.1 17.6001C14.5 18.0001 14.9 18.7001 14.9 19.8001C14.9 21.4001 14.9 22.7001 14.9 23.1001C14.9 23.4001 15.1 23.8001 15.7 23.7001C20.5 22.1001 23.9 17.6001 23.9 12.3001C24 5.70005 18.6 0.300049 12 0.300049Z" fill="currentColor"/>
            </svg>
            </a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/legacy/v3.3.0">Interchain Security Docs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/introduction/overview">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/features/key-assignment">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/consumer-development/app-integration">Consumer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/validators/overview">Validators Guide</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/legacy/v3.3.0/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/interchain-security/legacy/v3.3.0/adrs/intro">ADRs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/intro">ADRs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-007-pause-unbonding-on-eqv-prop">ADR Template</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-template">ADR Template</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-001-key-assignment">Key Assignment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle">Jail Throttling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-003-equivocation-gov-proposal">Equivocation governance proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-005-cryptographic-equivocation-verification">Cryptographic verification of equivocation evidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-008-throttle-retries">Throttle with retries</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-009-soft-opt-out">Soft Opt-Out</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-010-standalone-changeover">Standalone to Consumer Changeover</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-011-improving-test-confidence">Improving testing and increasing confidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-012-separate-releasing">Separate Releasing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-013-equivocation-slashing">Slashing on the provider for consumer equivocation</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Interchain Security<!-- --> <b>v3.3.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/interchain-security/legacy/">latest version</a></b> (<!-- -->v3.3.1-lsm<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interchain-security/legacy/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ADRs</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Improving testing and increasing confidence</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v3.3.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 11: Improving testing and increasing confidence</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog">​</a></h2><ul><li>2023-08-11: Proposed, first draft of ADR.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Proposed</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><p>Testing, QA, and maintenance of interchain-security libraries is an ever-evolving area of software engineering we have to keep incrementally improving. The purpose of the QA process is to catch bugs as early as possible. In an ideal development workflow a bug should never reach production. A bug found in the specification stage is a lot cheaper to resolve than a bug discovered in production (or even in testnet). Ideally, all bugs should be found during the CI execution, and we hope that no bugs will ever even reach the testnet (although nothing can replace actual system stress test under load interacting with users).</p><p>During development and testnet operation the following types of bugs were the most commonly found:</p><ul><li>improper iterator usage</li><li>unbounded array access/iteration</li><li>improper input handling and validation</li><li>improper cached context usage</li><li>non-determinism check (improper use of maps in go, relying on random values)</li><li>KV store management and/or how keys are defined</li><li>deserialization issues arising from consumer/provider versioning mismatch</li></ul><p>Such bugs can be discovered earlier with better tooling. Some of these bugs can induce increases in block times, chain halts, state corruption, or introduce an attack surface which is difficult to remove if other systems have started depending on that behavior.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="current-state-of-testing">Current state of testing<a href="#current-state-of-testing" class="hash-link" aria-label="Direct link to Current state of testing" title="Direct link to Current state of testing">​</a></h4><p>Our testing suites consist of multiple parts, each with their own trade-offs and benefits with regards to code coverage, complexity and confidence they provide.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="unit-testing">Unit testing<a href="#unit-testing" class="hash-link" aria-label="Direct link to Unit testing" title="Direct link to Unit testing">​</a></h3><p>Unit testing is employed mostly for testing single-module functionality. It is the first step in testing and often the most practical. While highly important, unit tests often <strong>test a single piece of code</strong> and don&#x27;t test relationships between different moving parts, this makes them less valuable when dealing with multi-module interactions.</p><p>Unit tests often employ mocks to abstract parts of the system that are not under test. Mocks are not equivalent to actual models and should not be treated as such.</p><p>Out of all the approaches used, unit testing has the most tools available and the coverage can simply be displayed as % of code lines tested. Although this is a very nice and very easy to understand metric, it does not speak about the quality of the test coverage.</p><p>Since distributed systems testing is a lot more involved, unit tests are oftentimes not sufficient to cover complex interactions. Unit tests are still necessary and helpful, but in cases where unit tests are not helpful e2e or integration tests should be favored.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="integration-testing">Integration testing<a href="#integration-testing" class="hash-link" aria-label="Direct link to Integration testing" title="Direct link to Integration testing">​</a></h3><p>With integration testing we <strong>test the multi-module interactions</strong> while isolating them from the remainder of the system.
Integration tests can uncover bugs that are often missed by unit tests.</p><p>It is very difficult to gauge the actual test coverage imparted by integration tests and the available tooling is limited.
In interchain-security we employ the <code>ibc-go/testing</code> framework to test interactions in-memory.</p><p>At present, integration testing does not involve the consensus layer - it is only concerned with application level state and logic.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="end-to-end-testing">End-to-end testing<a href="#end-to-end-testing" class="hash-link" aria-label="Direct link to End-to-end testing" title="Direct link to End-to-end testing">​</a></h3><p>In our context end-to-end testing comprises of tests that use the actual application binaries in an isolated environment (e.g. docker container). During test execution the inputs are meant to simulate actual user interaction, either by submitting transactions/queries using the command line or using gRPC/REST APIs and checking for state changes after an action has been performed. With this testing strategy we also include the consensus layer in all of our runs. This is the closest we can get to testing user interactions without starting a full testnet.</p><p>End-to-end testing strategies vary between different teams and projects and we strive to unify our approach to the best of our ability (at least for ICS and gaia).</p><p>The available tooling does not give us significant (or relevant) line of code coverage information since most of the tools are geared towards analyzing unit tests and simple code branch evaluation.</p><p>We aim to adapt our best practices by learning from other similar systems and projects such as cosmos-sdk, ibc-go and CometBFT.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-connect-specifications-to-code-and-tooling">1. Connect specifications to code and tooling<a href="#1-connect-specifications-to-code-and-tooling" class="hash-link" aria-label="Direct link to 1. Connect specifications to code and tooling" title="Direct link to 1. Connect specifications to code and tooling">​</a></h3><p>Oftentimes, specifications are disconnected from the development and QA processes. This gives rise to problems where the specification does not reflect the actual state of the system and vice-versa.
Usually specifications are just text files that are rarely used and go unmaintained after a while, resulting in consistency issues and misleading instructions/expectations about system behavior.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="decision-context-and-hypothesis">Decision context and hypothesis<a href="#decision-context-and-hypothesis" class="hash-link" aria-label="Direct link to Decision context and hypothesis" title="Direct link to Decision context and hypothesis">​</a></h4><p>Specifications written in a dedicated and executable specification language are easier to maintain than the ones written entirely in text.
Additionally, we can create models based on the specification OR make the model equivalent to a specification.</p><p>Models do not care about the intricacies of implementation and neither do specifications. Since both models and specifications care about concisely and accurately describing a system (such as a finite state machine), we see a benefit of adding model based tools (such as <a href="https://github.com/informalsystems/quint" target="_blank" rel="noopener noreferrer">quint</a>) to our testing and development workflows.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="main-benefit">Main benefit<a href="#main-benefit" class="hash-link" aria-label="Direct link to Main benefit" title="Direct link to Main benefit">​</a></h4><p>MBT tooling can be used to generate test traces that can be executed by multiple different testing setups.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-improve-e2e-tooling">2. Improve e2e tooling<a href="#2-improve-e2e-tooling" class="hash-link" aria-label="Direct link to 2. Improve e2e tooling" title="Direct link to 2. Improve e2e tooling">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="matrix-tests">Matrix tests<a href="#matrix-tests" class="hash-link" aria-label="Direct link to Matrix tests" title="Direct link to Matrix tests">​</a></h4><p>Instead of only running tests against current <code>main</code> branch we should adopt an approach where we also:</p><ul><li><strong>run regression tests against different released software versions</strong> (<code>ICS v1 vs v2 vs v3</code>)</li><li><strong>run non-determinism tests to uncover issues quickly</strong></li></ul><p>Matrix tests can be implemented using <a href="https://github.com/informalsystems/CometMock" target="_blank" rel="noopener noreferrer">CometMock</a> and refactoring our current e2e CI setup.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-e2e-regression-testing">Introducing e2e regression testing<a href="#introducing-e2e-regression-testing" class="hash-link" aria-label="Direct link to Introducing e2e regression testing" title="Direct link to Introducing e2e regression testing">​</a></h4><p>This e2e test suite would execute using a cronjob in our CI (nightly, multiple times a day etc.)</p><p>Briefly, the same set of traces is run against different <strong>maintained</strong> versions of the software and the <code>main</code> branch.
This would allow us to discover potential issues during development instead of in a testnet scenarios.</p><p>The most valuable issues that can be discovered in this way are <strong>state breaking changes</strong>, <strong>regressions</strong> and <strong>version incompatibilities</strong>.</p><p>The setup is illustrated by the image below.
<img loading="lazy" alt="e2e matrix tests" src="/interchain-security/legacy/assets/images/matrix_e2e_tests-30681305077301daaf3097e1952b54bb.png" width="2170" height="1624" class="img_ev3q"></p><p>This table explains which versions are tested against each other for the same set of test traces:</p><ul><li>✅ marks a passing test</li><li>❌ marks a failing test</li></ul><table><thead><tr><th><strong>USES: ICS v1 PROVIDER</strong></th><th><strong>start chain</strong></th><th><strong>add key</strong></th><th><strong>delegate</strong></th><th><strong>undelegate</strong></th><th><strong>redelegate</strong></th><th><strong>downtime</strong></th><th><strong>equivocation</strong></th><th><strong>stop chain</strong></th></tr></thead><tbody><tr><td><strong>v1 consumer (sdk45,ibc4.3)</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>v2 consumer (sdk45, ibc4.4)</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>v3 consumer (sdk47, ibc7)</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>main consumer</strong></td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td><strong>neutron</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>stride</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-e2e-cometmock-tests">Introducing e2e CometMock tests<a href="#introducing-e2e-cometmock-tests" class="hash-link" aria-label="Direct link to Introducing e2e CometMock tests" title="Direct link to Introducing e2e CometMock tests">​</a></h4><p>CometMock is a mock implementation of the <a href="https://github.com/cometbft/cometbft" target="_blank" rel="noopener noreferrer">CometBFT</a> consensus engine. It supports most operations performed by CometBFT while also being lightweight and relatively easy to use.</p><p>CometMock tests allow more nuanced control of test scenarios because CometMock can &quot;fool&quot; the blockchain app into thinking that a certain number of blocks had passed.
<strong>This allows us to test very nuanced scenarios, difficult edge cases and long-running operations (such as unbonding operations).</strong></p><p>Examples of tests made easier with CometMock are listed below:</p><ul><li>regression tests</li><li>non-determinism tests</li><li>upgrade tests</li><li>state-breaking changes</li></ul><p>With CometMock, the <strong>matrix test</strong> approach can also be used. The image below illustrates a CometMock setup that can be used to discover non-deterministic behavior and state-breaking changes.
<img loading="lazy" alt="e2e matrix tests" src="/interchain-security/legacy/assets/images/cometmock_matrix_test-714f36252aff9df4214823e3145d0ef5.png" width="3714" height="2082" class="img_ev3q"></p><p>This table explains which versions are tested against each other for the same set of test traces:</p><ul><li>✅ marks a passing test</li><li>❌ marks a failing test</li></ul><table><thead><tr><th><strong>SCENARIO</strong></th><th><strong>start chain</strong></th><th><strong>add key</strong></th><th><strong>delegate</strong></th><th><strong>undelegate</strong></th><th><strong>redelegate</strong></th><th><strong>downtime</strong></th><th><strong>equivocation</strong></th><th><strong>stop chain</strong></th></tr></thead><tbody><tr><td><strong>v3 provi + v3 consu</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>main provi + main consu</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>commit provi + commit consu</strong></td><td>✅</td><td>❌</td><td>✅</td><td>❌</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td></tr></tbody></table><p>Briefly; multiple versions of the application are run against the same CometMock instance and any deviations in app behavior would result in <code>app hash</code> errors (the apps would be in different states after performing the same set of actions).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-introduce-innovative-testing-approaches">3. Introduce innovative testing approaches<a href="#3-introduce-innovative-testing-approaches" class="hash-link" aria-label="Direct link to 3. Introduce innovative testing approaches" title="Direct link to 3. Introduce innovative testing approaches">​</a></h3><p>When discussing e2e testing, some very important patterns emerge - especially if test traces are used instead of ad-hoc tests written by hand.</p><p>We see a unique opportunity to clearly identify concerns and modularize the testing architecture. </p><p>The e2e testing frameworks can be split into a <strong>pipeline consisting of 3 parts: model, driver and harness</strong>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="model">Model<a href="#model" class="hash-link" aria-label="Direct link to Model" title="Direct link to Model">​</a></h4><p>Model is the part of the system that can emulate the behavior of the system under test.
Ideally, it is very close to the specification and is written in a specification language such as quint, TLA+ or similar.
One of the purposes of the model is that it can be used to generate test traces. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="driver">Driver<a href="#driver" class="hash-link" aria-label="Direct link to Driver" title="Direct link to Driver">​</a></h4><p>The purpose of the driver is to accept test traces (generated by the model or written by hand), process them and provide inputs to the next part of the pipeline.</p><p>Basically, the driver sits between the model and the actual infrastructure on which the test traces are being executed on.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="harness">Harness<a href="#harness" class="hash-link" aria-label="Direct link to Harness" title="Direct link to Harness">​</a></h4><p>Harness is the infrastructure layer of the pipeline that accepts inputs from the driver.</p><p>There can be multiple harnesses as long as they can perform four things:</p><ul><li>bootstrap a test execution environment (local, docker, k8s…)</li><li>accept inputs from drivers</li><li>perform the action specified by the driver</li><li>report results after performing actions</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><p>The procedure outlined in this ADR is not an all-or-nothing approach. Concepts introduced here do not rely on each other, so this ADR may only be applied partially without negative impact on test coverage and code confidence.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive">​</a></h3><ol><li>introduction of maintainable MBT solutions</li></ol><ul><li>improvement over the current &quot;difftest&quot; setup that relies on an opinionated typescript model and go driver</li></ul><ol start="2"><li>increased code coverage and confidence</li></ol><ul><li>using CometMock allows us to run more tests in less time</li><li>adding matrix e2e tests allows us to quickly pinpoint differences between code versions</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative">​</a></h3><p>It might be easier to forgo the MBT tooling and instead focus on pure property based testing</p><ul><li><a href="https://github.com/cosmos/interchain-security/pull/667" target="_blank" rel="noopener noreferrer">PBT proof of concept</a></li><li><a href="https://github.com/flyingmutant/rapid" target="_blank" rel="noopener noreferrer">property based testing in go</a></li></ul><p>The solutions are potentially expensive if we increase usage of the CI pipeline - this is fixed by running &quot;expensive&quot; tests using a cronjob, instead of running them on every commit.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="neutral">Neutral<a href="#neutral" class="hash-link" aria-label="Direct link to Neutral" title="Direct link to Neutral">​</a></h3><p>The process of changing development and testing process is not something that can be thought of and delivered quickly. Luckily, the changes can be rolled out incrementally without impacting existing workflows.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2><blockquote><p>Are there any relevant PR comments, issues that led up to this, or articles referenced for why we made the given design choice? If so link them here!</p></blockquote><ul><li><a href="https://github.com/cosmos/gaia/issues/2427" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/gaia/issues/2427</a></li><li><a href="https://github.com/cosmos/gaia/issues/2420" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/gaia/issues/2420</a></li><li><a href="https://github.com/cosmos/ibc-go/tree/main/e2e" target="_blank" rel="noopener noreferrer">ibc-go e2e tests</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/interchain-security/legacy/v3.3.0/adrs/adr-010-standalone-changeover"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Standalone to Consumer Changeover</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/interchain-security/legacy/v3.3.0/adrs/adr-012-separate-releasing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Separate Releasing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a><ul><li><a href="#unit-testing" class="table-of-contents__link toc-highlight">Unit testing</a></li><li><a href="#integration-testing" class="table-of-contents__link toc-highlight">Integration testing</a></li><li><a href="#end-to-end-testing" class="table-of-contents__link toc-highlight">End-to-end testing</a></li></ul></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#1-connect-specifications-to-code-and-tooling" class="table-of-contents__link toc-highlight">1. Connect specifications to code and tooling</a></li><li><a href="#2-improve-e2e-tooling" class="table-of-contents__link toc-highlight">2. Improve e2e tooling</a></li><li><a href="#3-introduce-innovative-testing-approaches" class="table-of-contents__link toc-highlight">3. Introduce innovative testing approaches</a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cosmos.network"><img src="/img/logo-bw.svg" alt="Cosmos Logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hub.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.tendermint.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tendermint Core<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ibc.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/cosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cosmosproject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Informal Systems</div></div></div></footer></div>
<script src="/interchain-security/legacy/assets/js/runtime~main.6dc179b3.js"></script>
<script src="/interchain-security/legacy/assets/js/main.206ddac4.js"></script>
</body>
</html>