<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v3.3.0 plugin-docs plugin-id-default docs-doc-id-adrs/adr-008-throttle-retries">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Throttle with retries | Interchain Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cosmos.github.io/interchain-security/legacy/img/banner.jpg"><meta data-rh="true" name="twitter:image" content="https://cosmos.github.io/interchain-security/legacy/img/banner.jpg"><meta data-rh="true" property="og:url" content="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-008-throttle-retries"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v3.3.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v3.3.0"><meta data-rh="true" name="docsearch:version" content="v3.3.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v3.3.0"><meta data-rh="true" property="og:title" content="Throttle with retries | Interchain Security"><meta data-rh="true" name="description" content="ADR 008: Throttle with retries"><meta data-rh="true" property="og:description" content="ADR 008: Throttle with retries"><link data-rh="true" rel="icon" href="/interchain-security/legacy/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-008-throttle-retries"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-008-throttle-retries" hreflang="en"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-008-throttle-retries" hreflang="x-default"><link rel="stylesheet" href="/interchain-security/legacy/assets/css/styles.f695a4a3.css">
<link rel="preload" href="/interchain-security/legacy/assets/js/runtime~main.6dc179b3.js" as="script">
<link rel="preload" href="/interchain-security/legacy/assets/js/main.206ddac4.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/interchain-security/legacy/"><b class="navbar__title text--truncate">Interchain Security</b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/interchain-security/legacy/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/interchain-security/legacy/">Next</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/">v3.3.1-lsm</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.3.0">v3.3.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.2.0">v3.2.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.1.0">v3.1.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v2.4.0-lsm">v2.4.0-lsm</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v2.0.0">v2.0.0</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cosmos/interchain-security" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="github-icon">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0.300049C5.4 0.300049 0 5.70005 0 12.3001C0 17.6001 3.4 22.1001 8.2 23.7001C8.8 23.8001 9 23.4001 9 23.1001C9 22.8001 9 22.1001 9 21.1001C5.7 21.8001 5 19.5001 5 19.5001C4.5 18.1001 3.7 17.7001 3.7 17.7001C2.5 17.0001 3.7 17.0001 3.7 17.0001C4.9 17.1001 5.5 18.2001 5.5 18.2001C6.6 20.0001 8.3 19.5001 9 19.2001C9.1 18.4001 9.4 17.9001 9.8 17.6001C7.1 17.3001 4.3 16.3001 4.3 11.7001C4.3 10.4001 4.8 9.30005 5.5 8.50005C5.5 8.10005 5 6.90005 5.7 5.30005C5.7 5.30005 6.7 5.00005 9 6.50005C10 6.20005 11 6.10005 12 6.10005C13 6.10005 14 6.20005 15 6.50005C17.3 4.90005 18.3 5.30005 18.3 5.30005C19 7.00005 18.5 8.20005 18.4 8.50005C19.2 9.30005 19.6 10.4001 19.6 11.7001C19.6 16.3001 16.8 17.3001 14.1 17.6001C14.5 18.0001 14.9 18.7001 14.9 19.8001C14.9 21.4001 14.9 22.7001 14.9 23.1001C14.9 23.4001 15.1 23.8001 15.7 23.7001C20.5 22.1001 23.9 17.6001 23.9 12.3001C24 5.70005 18.6 0.300049 12 0.300049Z" fill="currentColor"/>
            </svg>
            </a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/legacy/v3.3.0">Interchain Security Docs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/introduction/overview">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/features/key-assignment">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/consumer-development/app-integration">Consumer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/validators/overview">Validators Guide</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/legacy/v3.3.0/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/interchain-security/legacy/v3.3.0/adrs/intro">ADRs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/intro">ADRs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-007-pause-unbonding-on-eqv-prop">ADR Template</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-template">ADR Template</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-001-key-assignment">Key Assignment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle">Jail Throttling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-003-equivocation-gov-proposal">Equivocation governance proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-005-cryptographic-equivocation-verification">Cryptographic verification of equivocation evidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-008-throttle-retries">Throttle with retries</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-009-soft-opt-out">Soft Opt-Out</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-010-standalone-changeover">Standalone to Consumer Changeover</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-011-improving-test-confidence">Improving testing and increasing confidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-012-separate-releasing">Separate Releasing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-013-equivocation-slashing">Slashing on the provider for consumer equivocation</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Interchain Security<!-- --> <b>v3.3.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/interchain-security/legacy/">latest version</a></b> (<!-- -->v3.3.1-lsm<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interchain-security/legacy/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ADRs</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Throttle with retries</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v3.3.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Throttle with retries</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="adr-008-throttle-with-retries">ADR 008: Throttle with retries<a href="#adr-008-throttle-with-retries" class="hash-link" aria-label="Direct link to ADR 008: Throttle with retries" title="Direct link to ADR 008: Throttle with retries">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog">​</a></h2><ul><li>6/9/23: Initial draft</li><li>6/22/23: added note on consumer pending packets storage optimization</li><li>7/14/23: Added note on upgrade order</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><p>For context on why the throttling mechanism exists, see <a href="/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle">ADR 002</a>.</p><p>Note the terms slash throttling and jail throttling are synonymous, since in replicated security a <code>SlashPacket</code> simply jails a validator for downtime infractions.  </p><p>Currently the throttling mechanism is designed so that provider logic (slash meter, etc.) dictates how many <code>SlashPackets</code> can be handled over time.
Throttled <code>SlashPackets</code> are persisted on the provider, leading to multiple possible issues. Namely:</p><ul><li>If <code>SlashPackets</code> or <code>VSCMaturedPackets</code> are actually throttled/queued on the provider, state can grow and potentially lead to a DoS attack.
We have short term solutions around this, but overall they come with their own weaknesses.
See <a href="https://github.com/cosmos/interchain-security/issues/594" target="_blank" rel="noopener noreferrer">#594</a>.</li><li>If a jailing attack described in <a href="/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle">ADR 002</a> were actually to be carried out with the current throttling design, we&#x27;d likely have to halt the provider, and perform an emergency upgrade and/or migration to clear the queues of <code>SlashPackets</code> that were deemed to be malicious.
Alternatively, validators would just have to <em>tough it out</em> and wait for the queues to clear, during which all/most validators would be jailed.
Right after being jailed, validators would have to unjail themselves promptly to ensure safety.
The coordination required to maintain safety in such a scenario is not ideal.</li></ul><p>As as solution, we can improve the throttling mechanism to instead queue/persist relevant data on each consumer, and have consumers retry slash requests as needed.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-changes">Consumer changes<a href="#consumer-changes" class="hash-link" aria-label="Direct link to Consumer changes" title="Direct link to Consumer changes">​</a></h3><p>Note the consumer already queues up both <code>SlashPackets</code> and <code>VSCMaturedPackets</code> via <code>AppendPendingPacket</code>.
Those packets are dequeued in every <code>EndBlock</code> in <code>SendPackets</code> and sent to the provider.</p><p>Instead, we will now introduce the following logic on <code>EndBlock</code>:</p><ul><li>Slash packets will always be sent to the provider once they&#x27;re at the head of the queue.
However, once sent, the consumer will not send any subsequent <code>VSCMaturedPackets</code> from the queue until the provider responds with an acknowledgement that the sent <code>SlashPacket</code> has been handled, i.e., validator was jailed.
That is, <code>SlashPackets</code> block the sending of subsequent <code>VSCMaturedPackets</code> in the consumer queue.</li><li>If two <code>SlashPackets</code> are at the head of the queue, the consumer will send the first <code>SlashPacket</code>, and then wait for a success acknowledgement from the provider before sending the second <code>SlashPacket</code>.
This seems like it&#x27;d simplify implementation.</li><li><code>VSCMaturedPackets</code> at the head of the queue (i.e., NOT following a <code>SlashPacket</code>) can be sent immediately, and do not block any other packets in the queue, since the provider always handles them immediately.</li></ul><p>To prevent the provider from having to keep track of what <code>SlashPackets</code> have been rejected, the consumer will have to retry the sending of <code>SlashPackets</code> over some period of time.
This can be achieved with an on-chain consumer param, i.e., <code>RetryDelayPeriod</code>.
To reduce the amount of redundant re-sends, we recommend setting <code>RetryDelayPeriod ~ SlashMeterReplenishmentPeriod</code>, i.e., waiting for the provider slash meter to be replenished before resending the rejected <code>SlashPacket</code>.</p><p>Note to prevent weird edge case behavior, a retry would not be attempted until either a success or failure acknowledgement has been received from the provider.</p><p>With the behavior described, we maintain very similar behavior to the previous throttling mechanism regarding the timing that <code>SlashPackets</code> and <code>VSCMaturedPackets</code> are handled on the provider.
Obviously the queueing and blocking logic is moved, and the two chains would have to send more messages between one another (only in the case the throttling mechanism is triggered).</p><p>In the normal case, when no or a few <code>SlashPackets</code> are being sent, the <code>VSCMaturedPackets</code> will not be delayed, and hence unbonding will not be delayed.</p><p>For the implementation of this design, see <a href="https://github.com/cosmos/interchain-security/blob/fec3eccad59416cbdb6844e279f59e3f81242888/x/ccv/consumer/keeper/throttle_retry.go" target="_blank" rel="noopener noreferrer">throttle_retry.go</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-pending-packets-storage-optimization">Consumer pending packets storage optimization<a href="#consumer-pending-packets-storage-optimization" class="hash-link" aria-label="Direct link to Consumer pending packets storage optimization" title="Direct link to Consumer pending packets storage optimization">​</a></h4><p>In addition to the mentioned consumer changes, an optimization will need to be made to the consumer&#x27;s pending packets storage to properly implement the feature from this ADR.</p><p>The consumer ccv module previously queued &quot;pending packets&quot; to be sent in each <code>EndBlock</code> in <a href="https://github.com/cosmos/interchain-security/blob/3bc4e7135066d848aac60b0787364c07157fd36d/x/ccv/consumer/keeper/relay.go#L178" target="_blank" rel="noopener noreferrer">SendPackets</a>.
These packets are queued in state with a protobuf list of <code>ConsumerPacketData</code>.
For a single append operation, the entire list is deserialized, then a packet is appended to that list, and the list is serialized again.
See older version of <a href="https://github.com/cosmos/interchain-security/blob/05c2dae7c6372b1252b9e97215d07c6aa7618f33/x/ccv/consumer/keeper/keeper.go#L606" target="_blank" rel="noopener noreferrer">AppendPendingPacket</a>.
That is, a single append operation has O(N) complexity, where N is the size of the list.</p><p>This poor append performance isn&#x27;t a problem when the pending packets list is small.
But with this ADR being implemented, the pending packets list could potentially grow to the order of thousands of entries when <code>SlashPackets</code> need to be resent.</p><p>We can improve the append time for this queue by converting it from a protobuf-esq list, to a queue implemented with sdk-esq code.
The idea is to persist an uint64 index that will be incremented each time you queue up a packet.
You can think of this as storing the tail of the queue.
Then, packet data will be keyed by that index, making the data naturally ordered byte-wise for sdk&#x27;s iterator.
The index will also be stored in the packet data value bytes, so that the index can later be used to delete certain packets from the queue.</p><p>Two things are achieved with this approach:</p><ul><li>More efficient packet append/enqueue times</li><li>The ability to delete select packets from the queue (previously all packets were deleted at once)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="provider-changes">Provider changes<a href="#provider-changes" class="hash-link" aria-label="Direct link to Provider changes" title="Direct link to Provider changes">​</a></h3><p>The main change needed for the provider is the removal of queuing logic for <code>SlashPackets</code> and <code>VSCMaturedPackets</code> upon being received.</p><p>Instead, the provider will consult the slash meter to determine if a <code>SlashPacket</code> can be handled immediately.
If not, the provider will return an acknowledgement message to the consumer communicating that the <code>SlashPacket</code> could not be handled, and needs to be sent again in the future (retried).</p><p><code>VSCMaturedPackets</code> will always be handled immediately upon being received by the provider.</p><p>Note <a href="https://github.com/cosmos/ibc/blob/main/spec/app/ics-028-cross-chain-validation/system_model_and_properties.md#consumer-initiated-slashing" target="_blank" rel="noopener noreferrer">spec</a>. Specifically the section on <em>VSC Maturity and Slashing Order</em>. Previously the onus was on the provider to maintain this property via queuing packets and handling them FIFO.</p><p>Now this property will be maintained by the consumer sending packets in the correct order, and blocking the sending of <code>VSCMaturedPackets</code> as needed. Then, the ordered IBC channel will ensure that <code>SlashPackets</code> and <code>VSCMaturedPackets</code> are received in the correct order on the provider.</p><p>The provider&#x27;s main responsibility regarding throttling will now be to determine if a received <code>SlashPacket</code> can be handled via slash meter etc., and appropriately acknowledge to the sending consumer.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="handling-vscmaturedpackets-immediately">Handling <code>VSCMaturedPackets</code> immediately<a href="#handling-vscmaturedpackets-immediately" class="hash-link" aria-label="Direct link to handling-vscmaturedpackets-immediately" title="Direct link to handling-vscmaturedpackets-immediately">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="why-the-provider-can-handle-vscmatured-packets-immediately">Why the provider can handle VSCMatured packets immediately<a href="#why-the-provider-can-handle-vscmatured-packets-immediately" class="hash-link" aria-label="Direct link to Why the provider can handle VSCMatured packets immediately" title="Direct link to Why the provider can handle VSCMatured packets immediately">​</a></h4><p>A <code>VSCMaturedPacket</code> communicates to the provider that sufficient time passed on the consumer since the corresponding <code>VSCPacket</code> has been applied (on the consumer) such that infractions committed on the consumer could have been submitted.</p><p>If the consumer is following the queuing/blocking protocol described, then no bad behavior occurs and the <em>VSC Maturity and Slashing Order</em> property is maintained.</p><p>If a consumer sends <code>VSCMaturedPackets</code> too leniently -- the consumer is malicious and sends duplicate <code>VSCMaturedPackets</code>, or sends the packets sooner than the CCV protocol specifies -- then the provider needs to handle <code>VSCMaturedPackets</code> immediately to prevent DOS, state bloat, or other issues.
The only possible negative outcome is that the malicious consumer may not be able to jail a validator who should have been jailed.
The malicious behavior only creates a negative outcome for the consumer chain that is being malicious.</p><p>If a consumer blocks the sending of <code>VSCMaturedPackets</code>, then unbonding operations on the provider will be delayed, but only until the VSC timeout period has elapsed.
At that time, the consumer is removed.
Again the malicious behavior only creates a negative outcome for the consumer chain that is being malicious.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="splitting-of-prs-and-upgrade-order">Splitting of PRs and Upgrade Order<a href="#splitting-of-prs-and-upgrade-order" class="hash-link" aria-label="Direct link to Splitting of PRs and Upgrade Order" title="Direct link to Splitting of PRs and Upgrade Order">​</a></h3><p>This feature will implement consumer changes in <a href="https://github.com/cosmos/interchain-security/pull/1024" target="_blank" rel="noopener noreferrer">#1024</a>. </p><p>❗<strong><em>These changes should be deployed to production for all consumers before the provider changes are deployed to production.</em></strong> </p><p>In other words, the consumer changes in <a href="https://github.com/cosmos/interchain-security/pull/1024" target="_blank" rel="noopener noreferrer">#1024</a> are compatible with the current (&quot;v1&quot;) provider implementation of throttling that&#x27;s running on the Cosmos Hub as of July 2023.</p><p>Once all consumers have deployed the changes in #1024, the provider changes from <a href="https://github.com/cosmos/interchain-security/pull/1321" target="_blank" rel="noopener noreferrer">#1321</a> can be deployed to production, fully enabling v2 throttling.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><ul><li>Consumers will now have to manage their own queues, and retry logic.</li><li>Consumers still aren&#x27;t trustless, but the provider is now less susceptible to mismanaged or malicious consumers.</li><li>Recovering from the &quot;jailing attack&quot; is more elegant.</li><li>Some issues like <a href="https://github.com/cosmos/interchain-security/issues/1001" target="_blank" rel="noopener noreferrer">#1001</a> will now be handled implicitly by the improved throttling mechanism.</li><li><code>SlashPackets</code> and <code>VSCMaturedPackets</code> can be handled immediately once received by the provider if the slash meter allows.</li><li>In general, we reduce the amount of computation that happens in the provider <code>EndBlock</code>.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive">​</a></h3><ul><li>We no longer have to reason about a &quot;global queue&quot; and a &quot;chain specific queue&quot;, and keeping those all in-sync.
Now <code>SlashPackets</code> and <code>VSCMaturedPackets</code> queuing is handled on each consumer individually.</li><li>Due to the above, the throttling protocol becomes less complex overall.</li><li>We no longer have to worry about throttle related DoS attack on the provider, since no queuing exists on the provider.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative">​</a></h3><ul><li>Increased number of IBC packets being relayed anytime throttling logic is triggered.</li><li>Consumer complexity increases, since consumers now have manage queuing themselves, and implement packet retry logic.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="neutral">Neutral<a href="#neutral" class="hash-link" aria-label="Direct link to Neutral" title="Direct link to Neutral">​</a></h3><ul><li>Core throttling logic on the provider remains unchanged, i.e., slash meter, replenishment cycles, etc.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2><ul><li><a href="https://github.com/cosmos/interchain-security/issues/713" target="_blank" rel="noopener noreferrer">EPIC</a> tracking the changes proposed by this ADR</li><li><a href="/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle">ADR 002: Jail Throttling</a></li><li><a href="https://github.com/cosmos/interchain-security/issues/594" target="_blank" rel="noopener noreferrer">#594</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/interchain-security/legacy/v3.3.0/adrs/adr-005-cryptographic-equivocation-verification"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cryptographic verification of equivocation evidence</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/interchain-security/legacy/v3.3.0/adrs/adr-009-soft-opt-out"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Soft Opt-Out</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#adr-008-throttle-with-retries" class="table-of-contents__link toc-highlight">ADR 008: Throttle with retries</a></li><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#consumer-changes" class="table-of-contents__link toc-highlight">Consumer changes</a></li><li><a href="#provider-changes" class="table-of-contents__link toc-highlight">Provider changes</a></li><li><a href="#splitting-of-prs-and-upgrade-order" class="table-of-contents__link toc-highlight">Splitting of PRs and Upgrade Order</a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cosmos.network"><img src="/img/logo-bw.svg" alt="Cosmos Logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hub.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.tendermint.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tendermint Core<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ibc.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/cosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cosmosproject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Informal Systems</div></div></div></footer></div>
<script src="/interchain-security/legacy/assets/js/runtime~main.6dc179b3.js"></script>
<script src="/interchain-security/legacy/assets/js/main.206ddac4.js"></script>
</body>
</html>