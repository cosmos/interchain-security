<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v3.3.0 plugin-docs plugin-id-default docs-doc-id-adrs/adr-002-throttle">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Jail Throttling | Interchain Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cosmos.github.io/interchain-security/legacy/img/banner.jpg"><meta data-rh="true" name="twitter:image" content="https://cosmos.github.io/interchain-security/legacy/img/banner.jpg"><meta data-rh="true" property="og:url" content="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v3.3.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v3.3.0"><meta data-rh="true" name="docsearch:version" content="v3.3.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v3.3.0"><meta data-rh="true" property="og:title" content="Jail Throttling | Interchain Security"><meta data-rh="true" name="description" content="Changelog"><meta data-rh="true" property="og:description" content="Changelog"><link data-rh="true" rel="icon" href="/interchain-security/legacy/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle" hreflang="en"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle" hreflang="x-default"><link rel="stylesheet" href="/interchain-security/legacy/assets/css/styles.f695a4a3.css">
<link rel="preload" href="/interchain-security/legacy/assets/js/runtime~main.6dc179b3.js" as="script">
<link rel="preload" href="/interchain-security/legacy/assets/js/main.206ddac4.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/interchain-security/legacy/"><b class="navbar__title text--truncate">Interchain Security</b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/interchain-security/legacy/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/interchain-security/legacy/">Next</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/">v3.3.1-lsm</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.3.0">v3.3.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.2.0">v3.2.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v3.1.0">v3.1.0</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v2.4.0-lsm">v2.4.0-lsm</a></li><li><a class="dropdown__link" href="/interchain-security/legacy/v2.0.0">v2.0.0</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cosmos/interchain-security" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="github-icon">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0.300049C5.4 0.300049 0 5.70005 0 12.3001C0 17.6001 3.4 22.1001 8.2 23.7001C8.8 23.8001 9 23.4001 9 23.1001C9 22.8001 9 22.1001 9 21.1001C5.7 21.8001 5 19.5001 5 19.5001C4.5 18.1001 3.7 17.7001 3.7 17.7001C2.5 17.0001 3.7 17.0001 3.7 17.0001C4.9 17.1001 5.5 18.2001 5.5 18.2001C6.6 20.0001 8.3 19.5001 9 19.2001C9.1 18.4001 9.4 17.9001 9.8 17.6001C7.1 17.3001 4.3 16.3001 4.3 11.7001C4.3 10.4001 4.8 9.30005 5.5 8.50005C5.5 8.10005 5 6.90005 5.7 5.30005C5.7 5.30005 6.7 5.00005 9 6.50005C10 6.20005 11 6.10005 12 6.10005C13 6.10005 14 6.20005 15 6.50005C17.3 4.90005 18.3 5.30005 18.3 5.30005C19 7.00005 18.5 8.20005 18.4 8.50005C19.2 9.30005 19.6 10.4001 19.6 11.7001C19.6 16.3001 16.8 17.3001 14.1 17.6001C14.5 18.0001 14.9 18.7001 14.9 19.8001C14.9 21.4001 14.9 22.7001 14.9 23.1001C14.9 23.4001 15.1 23.8001 15.7 23.7001C20.5 22.1001 23.9 17.6001 23.9 12.3001C24 5.70005 18.6 0.300049 12 0.300049Z" fill="currentColor"/>
            </svg>
            </a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/legacy/v3.3.0">Interchain Security Docs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/introduction/overview">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/features/key-assignment">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/consumer-development/app-integration">Consumer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/legacy/v3.3.0/validators/overview">Validators Guide</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/legacy/v3.3.0/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/interchain-security/legacy/v3.3.0/adrs/intro">ADRs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/intro">ADRs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-007-pause-unbonding-on-eqv-prop">ADR Template</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-template">ADR Template</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-001-key-assignment">Key Assignment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-002-throttle">Jail Throttling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-003-equivocation-gov-proposal">Equivocation governance proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-005-cryptographic-equivocation-verification">Cryptographic verification of equivocation evidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-008-throttle-retries">Throttle with retries</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-009-soft-opt-out">Soft Opt-Out</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-010-standalone-changeover">Standalone to Consumer Changeover</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-011-improving-test-confidence">Improving testing and increasing confidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-012-separate-releasing">Separate Releasing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/legacy/v3.3.0/adrs/adr-013-equivocation-slashing">Slashing on the provider for consumer equivocation</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Interchain Security<!-- --> <b>v3.3.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/interchain-security/legacy/">latest version</a></b> (<!-- -->v3.3.1-lsm<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interchain-security/legacy/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ADRs</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Jail Throttling</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v3.3.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 002: Jail Throttling</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog">​</a></h2><ul><li>2023-01-26: Initial Draft</li><li>2023-02-07: Property refined, ADR ready to review/merge</li><li>2023-11-22: Refactor for better understanding</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><p>The CCV spec is based around the assumption that the provider binary and all consumers binaries are non-malicious, and follow the defined protocols.
In practice, this assumption may not hold.
A malicious consumer binary could potentially include code which is able to send many slash/jail packets at once to the provider.</p><p>Before the throttling feature was implemented, the following attack was possible.
Attacker(s) would create provider validators just below the provider&#x27;s active set.
Using a malicious consumer binary, slash packets would be relayed to the provider, that would slash/jail a significant portion (or all) of honest validator at once.
Control of the provider would then pass over to the attackers&#x27; validators.
This enables the attacker(s) to halt the provider.
Or even worse, commit arbitrary state on the provider, potentially stealing all tokens bridged to the provider over IBC.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><p>The throttling feature was designed to slow down the mentioned attack from above, allowing validators and the community to appropriately respond to the attack,
i.e., this feature limits (enforced by on-chain params) the rate that the provider validator set can be jailed over time.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="required-state">Required State<a href="#required-state" class="hash-link" aria-label="Direct link to Required State" title="Direct link to Required State">​</a></h3><p><strong>Slash meter:</strong> There exists one slash meter on the provider which stores an amount of voting power (integer), corresponding to an allowance of validators that can be jailed over time.
This meter is initialized to a certain value on genesis, decremented by the amount of voting power jailed whenever a slash packet is handled, and periodically replenished as decided by on-chain params.</p><p><strong>Global entry queue:</strong> There exists a single queue which stores &quot;global slash entries&quot;.
These entries allow the provider to appropriately handle slash packets sent from any consumer in FIFO ordering.
This queue is responsible for coordinating the order that slash packets (from multiple chains) are handled over time.</p><p><strong>Per-chain data queue:</strong> For each established consumer, there exists a queue which stores &quot;throttled packet data&quot;,
i.e.,pending slash packet data is queued together with pending VSC matured packet data in FIFO ordering.
Order is enforced by IBC sequence number.
These &quot;per-chain&quot; queues are responsible for coordinating the order that slash packets are handled in relation to VSC matured packets from the same chain.</p><p><em>Note:</em> The reason for a multiple-queue design is the <em>VSC Maturity and Slashing Order</em> property (see <a href="https://github.com/cosmos/ibc/blob/main/spec/app/ics-028-cross-chain-validation/system_model_and_properties.md#consumer-initiated-slashing" target="_blank" rel="noopener noreferrer">spec</a>).
There are other ways to ensure such a property (like a queue of linked lists, etc.), but the proposed approach seemed to be the most understandable and easiest to implement with a KV store.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="params">Params<a href="#params" class="hash-link" aria-label="Direct link to Params" title="Direct link to Params">​</a></h3><p><code>SlashMeterReplenishPeriod</code> -- the period after which the slash meter is replenished. </p><p><code>SlashMeterReplenishFraction</code> -- the portion (in range <!-- -->[0, 1]<!-- -->) of total voting power that is replenished to the slash meter when a replenishment occurs. This param also serves as a maximum fraction of total voting power that the slash meter can hold.</p><p><code>MaxThrottledPackets</code> -- the maximum amount of throttled slash or vsc matured packets that can be queued from a single consumer before the provider chain halts, it should be set to a large value.
This param would allow provider binaries to panic deterministically in the event that packet throttling results in a large amount of state-bloat. In such a scenario, packet throttling could prevent a violation of safety caused by a malicious consumer, at the cost of provider liveness.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-overview">Protocol Overview<a href="#protocol-overview" class="hash-link" aria-label="Direct link to Protocol Overview" title="Direct link to Protocol Overview">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="onrecvslashpacket">OnRecvSlashPacket<a href="#onrecvslashpacket" class="hash-link" aria-label="Direct link to OnRecvSlashPacket" title="Direct link to OnRecvSlashPacket">​</a></h4><p>Upon the provider receiving a slash packet from any of the established consumers during block execution, two things occur:</p><ol><li>A global slash entry is queued.</li><li>The data of such a packet is added to the per-chain queue.</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="onrecvvscmaturedpacket">OnRecvVSCMaturedPacket<a href="#onrecvvscmaturedpacket" class="hash-link" aria-label="Direct link to OnRecvVSCMaturedPacket" title="Direct link to OnRecvVSCMaturedPacket">​</a></h4><p>Upon the provider receiving a VSCMatured packet from any of the established consumers during block execution, the VSCMatured packet data is added to the per-chain queue.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="endblocker">Endblocker<a href="#endblocker" class="hash-link" aria-label="Direct link to Endblocker" title="Direct link to Endblocker">​</a></h4><p>In the <code>EndBlock</code> of the provider CCV module, there are three actions performed:</p><ul><li>replenish the slash meter;</li><li>handle the leading <code>VSCMaturedPackets</code>;</li><li>and handle the throttle queues.</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="slash-meter-replenishment">Slash Meter Replenishment<a href="#slash-meter-replenishment" class="hash-link" aria-label="Direct link to Slash Meter Replenishment" title="Direct link to Slash Meter Replenishment">​</a></h5><p>Once the slash meter becomes not full, it&#x27;ll be replenished after <code>SlashMeterReplenishPeriod</code> by incrementing the meter with its allowance for the replenishment block, where <code>allowance</code> = <code>SlashMeterReplenishFraction</code> * <code>currentTotalVotingPower</code>.
The slash meter will never exceed its current allowance (function of the total voting power for the block) in value. </p><p>Note a few things:</p><ol><li>The slash meter can go negative in value, and will do so when handling a single slash packet that jails a validator with significant voting power.
In such a scenario, the slash meter may take multiple replenishment periods to once again reach a positive value (or 0), meaning no other slash packets may be handled for multiple replenishment periods.</li><li>Total voting power of a chain changes over time, especially as validators are jailed.
As validators are jailed, total voting power decreases, and so does the jailing allowance.
See below for more detailed throttling property discussion.</li><li>The voting power allowance added to the slash meter during replenishment will always be greater than or equal to 1.
If the <code>SlashMeterReplenishFraction</code> is set too low, integer rounding will put this minimum value into effect.
That is, if <code>SlashMeterReplenishFraction</code> * <code>currentTotalVotingPower</code> &lt; 1, then the effective allowance would be 1.
This min value of allowance ensures that there&#x27;s some packets handled over time, even if that is a very long time.
It&#x27;s a crude solution to an edge case caused by too small of a replenishment fraction.</li></ol><p>The behavior described above is achieved by executing <code>CheckForSlashMeterReplenishment()</code> every <code>EndBlock</code>, BEFORE <code>HandleThrottleQueues()</code> is executed.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="handle-leading-vscmaturedpackets">Handle Leading VSCMaturedPackets<a href="#handle-leading-vscmaturedpackets" class="hash-link" aria-label="Direct link to Handle Leading VSCMaturedPackets" title="Direct link to Handle Leading VSCMaturedPackets">​</a></h5><p>In every block, it is possible that <code>VSCMaturedPacket</code> data was queued before any slash packet data.
Since this &quot;leading&quot; VSCMatured packet data does not have to be throttled (see <em>VSC Maturity and Slashing Order</em>), we can handle all VSCMatured packet data at the head of the queue, before the any throttling or packet data handling logic executes.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="handle-throttle-queues">Handle Throttle Queues<a href="#handle-throttle-queues" class="hash-link" aria-label="Direct link to Handle Throttle Queues" title="Direct link to Handle Throttle Queues">​</a></h5><p>In every <code>EndBlock</code>, the following logic is executed to handle data from the throttle queues.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">meter </span><span class="token operator">:</span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getSlashMeter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Keep iterating as long as the meter has a positive (or 0) value, and global slash entries exist </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">while</span><span class="token plain"> meter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsPositiveOrZero</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">entriesExist</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// Get next entry in queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     entry </span><span class="token operator">:</span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getNextGlobalSlashEntry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// Decrement slash meter by the voting power that will be removed from the valset from handling this slash packet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     valPower </span><span class="token operator">:</span><span class="token operator">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">getValPower</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     meter </span><span class="token operator">=</span><span class="token plain"> meter </span><span class="token operator">-</span><span class="token plain"> valPower</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// Using the per-chain queue, handle the single slash packet using its queued data,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// then handle all trailing VSCMatured packets for this consumer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token function" style="color:rgb(80, 250, 123)">handleSlashPacketAndTrailingVSCMaturedPackets</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// Delete entry in global queue, delete handled data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     entry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Delete</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token function" style="color:rgb(80, 250, 123)">deleteThrottledSlashPacketData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     </span><span class="token function" style="color:rgb(80, 250, 123)">deleteTrailingVSCMaturedPacketData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="system-properties">System Properties<a href="#system-properties" class="hash-link" aria-label="Direct link to System Properties" title="Direct link to System Properties">​</a></h3><p>All CCV system properties should be maintained by implementing this feature, see <a href="https://github.com/cosmos/ibc/blob/main/spec/app/ics-028-cross-chain-validation/system_model_and_properties.md#consumer-initiated-slashing" target="_blank" rel="noopener noreferrer">CCV spec - Consumer Initiated Slashing</a>.</p><p>One implementation-specific property introduced is that if any of the chain-specific packet data queues become larger than <code>MaxThrottledPackets</code>, then the provider binary will panic, and the provider chain will halt.
Therefore this param should be set carefully. See <code>SetThrottledPacketDataSize</code>.
This behavior ensures that if the provider binaries are queuing up more packet data than machines can handle, the provider chain halts deterministically between validators.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="main-throttling-property">Main Throttling Property<a href="#main-throttling-property" class="hash-link" aria-label="Direct link to Main Throttling Property" title="Direct link to Main Throttling Property">​</a></h3><p>Using on-chain params and the sub protocol defined, slash packet throttling is implemented such that the following property holds under some conditions.</p><p>First, we introduce the following definitions:</p><ul><li>A consumer initiated slash attack &quot;starts&quot; when the first slash packet from such an attack is received by the provider.</li><li>The &quot;initial validator set&quot; for the attack is the validator set that existed on the provider when the attack started.</li><li>There is a list of honest validators such that if they are jailed, <code>X</code>% of the initial validator set will be jailed.</li></ul><p>For the Throttling Property to hold, the following assumptions must be true:</p><ol><li>We assume the total voting power of the chain (as a function of delegations) does not increase over the course of the attack.</li><li>No validator has more than <code>SlashMeterReplenishFraction</code> of total voting power on the provider.</li><li><code>SlashMeterReplenishFraction</code> is large enough that <code>SlashMeterReplenishFraction</code> * <code>currentTotalVotingPower</code> &gt; 1,
i.e., the replenish fraction is set high enough that we can ignore the effects of rounding.</li><li><code>SlashMeterReplenishPeriod</code> is sufficiently longer than the time it takes to produce a block.</li></ol><p><em>Note if these assumptions do not hold, throttling will still slow down the described attack in most cases, just not in a way that can be succinctly described. It&#x27;s possible that more complex properties can be defined.</em></p><p><strong>Throttling Property</strong>: The time it takes to jail/tombstone <code>X</code>% of the initial validator set will be greater than or equal to
$\mathit{SlashMeterReplenishPeriod} \cdot \frac{X}{\mathit{SlashMeterReplenishFraction}} - 2 \cdot \mathit{SlashMeterReplenishPeriod}$.</p><blockquote><p><strong>Intuition</strong></p><p>Let&#x27;s use the following notation:</p><ul><li>$C$: Number of replenishment cycles</li><li>$P$: $\mathit{SlashMeterReplenishPeriod}$</li><li>$F$: $\mathit{SlashMeterReplenishFraction}$</li><li>$V_{\mathit{max}}$: Max power of a validator as a fraction of total voting power</li></ul><p>In $C$ number of replenishment cycles, the fraction of total voting power that can be removed, $a$, is $a \leq F \cdot C + V<em>{\mathit{max}}$ (where $V</em>{\mathit{max}}$ is there to account for the power fraction of the last validator removed, one which pushes the meter to the negative value).</p><p>So, we need at least $C \geq \frac{a - V_{\mathit{max}}}{F}$ cycles to remove $a$ fraction of the total voting power.</p><p>Since we defined the start of the attack to be the moment when the first slash request arrives, then $F$ fraction of the initial validator set can be jailed immediately. For the remaining $X - F$ fraction of the initial validator set to be jailed, it takes at least $C \geq \frac{(X - F) - V<em>{\mathit{max}}}{F}$ cycles. Using the assumption that $V</em>{\mathit{max}} \leq F$ (assumption 2), we get $C \geq \frac{X - 2F}{F}$ cycles.</p><p>In order to execute $C$ cycles, we need $C \cdot P$ time.</p><p>Thus, jailing the remaining $X - F$ fraction of the initial validator set corresponds to $\frac{P \cdot (X - 2F)}{F}$ time.</p><p>In other words, the attack must take at least $\frac{P \cdot X}{F} - 2P$ time (in the units of replenish period $P$).</p></blockquote><p>This property is useful because it allows us to reason about the time it takes to jail a certain percentage of the initial provider validator set from consumer initiated slash requests.
For example, if <code>SlashMeterReplenishFraction</code> is set to <code>0.06</code>, then it takes no less than 4 replenishment periods to jail 33% of the initial provider validator set on the Cosmos Hub.
Note that as of writing this on 11/29/22, the Cosmos Hub does not have a validator with more than 6% of total voting power.</p><p>Note also that 4 replenishment period is a worst case scenario that depends on well crafted attack timings.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-unjailing-affects-the-main-throttling-property">How Unjailing Affects the Main Throttling Property<a href="#how-unjailing-affects-the-main-throttling-property" class="hash-link" aria-label="Direct link to How Unjailing Affects the Main Throttling Property" title="Direct link to How Unjailing Affects the Main Throttling Property">​</a></h3><p>Note that the jailing allowance is directly proportional to the current total voting power of the provider chain. Therefore, if honest validators don&#x27;t unjail themselves during the attack, the total voting power of the provider chain will decrease over the course of the attack, and the attack will be slowed down, main throttling property is maintained.</p><p>If honest validators do unjail themselves, the total voting power of the provider chain will still not become higher than when the attack started (unless new token delegations happen), therefore the main property is still maintained. Moreover, honest validators unjailing themselves helps prevent the attacking validators from gaining control of the provider.</p><p>In summary, the throttling mechanism as designed has desirable properties whether or not honest validators unjail themselves over the course of the attack.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive">​</a></h3><ul><li>The described attack is slowed down in seemingly all cases.</li><li>If certain assumptions hold, the described attack is slowed down in a way that can be precisely time-bounded.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative">​</a></h3><ul><li>Throttling introduces a vector for a malicious consumer chain to halt the provider, see issue below.
However, this is sacrificing liveness in a edge case scenario for the sake of security.
As an improvement, <a href="https://github.com/cosmos/interchain-security/issues/713" target="_blank" rel="noopener noreferrer">using retries</a> would fully prevent this attack vector.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="neutral">Neutral<a href="#neutral" class="hash-link" aria-label="Direct link to Neutral" title="Direct link to Neutral">​</a></h3><ul><li>Additional state is introduced to the provider chain.</li><li>VSCMatured and slash packet data is not always handled in the same block that it is received.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2><ul><li><a href="https://github.com/cosmos/interchain-security/issues/404" target="_blank" rel="noopener noreferrer">Original issue inspiring throttling feature</a></li><li><a href="https://github.com/cosmos/interchain-security/issues/594" target="_blank" rel="noopener noreferrer">Issue on DOS vector</a></li><li><a href="https://github.com/cosmos/interchain-security/issues/685" target="_blank" rel="noopener noreferrer">Consideration of another attack vector</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/interchain-security/legacy/v3.3.0/adrs/adr-001-key-assignment"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Key Assignment</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/interchain-security/legacy/v3.3.0/adrs/adr-003-equivocation-gov-proposal"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Equivocation governance proposal</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#required-state" class="table-of-contents__link toc-highlight">Required State</a></li><li><a href="#params" class="table-of-contents__link toc-highlight">Params</a></li><li><a href="#protocol-overview" class="table-of-contents__link toc-highlight">Protocol Overview</a></li><li><a href="#system-properties" class="table-of-contents__link toc-highlight">System Properties</a></li><li><a href="#main-throttling-property" class="table-of-contents__link toc-highlight">Main Throttling Property</a></li><li><a href="#how-unjailing-affects-the-main-throttling-property" class="table-of-contents__link toc-highlight">How Unjailing Affects the Main Throttling Property</a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cosmos.network"><img src="/img/logo-bw.svg" alt="Cosmos Logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hub.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.tendermint.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tendermint Core<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ibc.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/cosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cosmosproject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Informal Systems</div></div></div></footer></div>
<script src="/interchain-security/legacy/assets/js/runtime~main.6dc179b3.js"></script>
<script src="/interchain-security/legacy/assets/js/main.206ddac4.js"></script>
</body>
</html>