<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-v5.2.0 docs-doc-page docs-doc-id-adrs/adr-015-partial-set-security" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Partial Set Security | Interchain Security</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cosmos.github.io/interchain-security/img/banner.png"><meta data-rh="true" name="twitter:image" content="https://cosmos.github.io/interchain-security/img/banner.png"><meta data-rh="true" property="og:url" content="https://cosmos.github.io/interchain-security/v5.2.0/adrs/adr-015-partial-set-security"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v5.2.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v5.2.0"><meta data-rh="true" name="docsearch:version" content="v5.2.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v5.2.0"><meta data-rh="true" property="og:title" content="Partial Set Security | Interchain Security"><meta data-rh="true" name="description" content="Changelog"><meta data-rh="true" property="og:description" content="Changelog"><link data-rh="true" rel="icon" href="/interchain-security/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://cosmos.github.io/interchain-security/v5.2.0/adrs/adr-015-partial-set-security"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/v5.2.0/adrs/adr-015-partial-set-security" hreflang="en"><link data-rh="true" rel="alternate" href="https://cosmos.github.io/interchain-security/v5.2.0/adrs/adr-015-partial-set-security" hreflang="x-default"><link rel="stylesheet" href="/interchain-security/assets/css/styles.5e0b2b97.css">
<script src="/interchain-security/assets/js/runtime~main.7a460333.js" defer="defer"></script>
<script src="/interchain-security/assets/js/main.e0613764.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/interchain-security/"><div class="navbar__logo"><img src="/interchain-security/img/hub.svg" alt="Interchain Security Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/interchain-security/img/hub.svg" alt="Interchain Security Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Interchain Security</b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/interchain-security/v5.2.0">v5.2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interchain-security/adrs/adr-015-partial-set-security">Next</a></li><li><a class="dropdown__link" href="/interchain-security/v6.4.0/adrs/adr-015-partial-set-security">v6.4.0</a></li><li><a class="dropdown__link" href="/interchain-security/v6.3.0/adrs/adr-015-partial-set-security">v6.3.0</a></li><li><a class="dropdown__link" href="/interchain-security/v6.1.0/adrs/adr-015-partial-set-security">v6.1.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/interchain-security/v5.2.0/adrs/adr-015-partial-set-security">v5.2.0</a></li><li><a class="dropdown__link" href="/interchain-security/v4.5.0/adrs/adr-015-partial-set-security">v4.5.0</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cosmos/interchain-security" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="github-icon">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0.300049C5.4 0.300049 0 5.70005 0 12.3001C0 17.6001 3.4 22.1001 8.2 23.7001C8.8 23.8001 9 23.4001 9 23.1001C9 22.8001 9 22.1001 9 21.1001C5.7 21.8001 5 19.5001 5 19.5001C4.5 18.1001 3.7 17.7001 3.7 17.7001C2.5 17.0001 3.7 17.0001 3.7 17.0001C4.9 17.1001 5.5 18.2001 5.5 18.2001C6.6 20.0001 8.3 19.5001 9 19.2001C9.1 18.4001 9.4 17.9001 9.8 17.6001C7.1 17.3001 4.3 16.3001 4.3 11.7001C4.3 10.4001 4.8 9.30005 5.5 8.50005C5.5 8.10005 5 6.90005 5.7 5.30005C5.7 5.30005 6.7 5.00005 9 6.50005C10 6.20005 11 6.10005 12 6.10005C13 6.10005 14 6.20005 15 6.50005C17.3 4.90005 18.3 5.30005 18.3 5.30005C19 7.00005 18.5 8.20005 18.4 8.50005C19.2 9.30005 19.6 10.4001 19.6 11.7001C19.6 16.3001 16.8 17.3001 14.1 17.6001C14.5 18.0001 14.9 18.7001 14.9 19.8001C14.9 21.4001 14.9 22.7001 14.9 23.1001C14.9 23.4001 15.1 23.8001 15.7 23.7001C20.5 22.1001 23.9 17.6001 23.9 12.3001C24 5.70005 18.6 0.300049 12 0.300049Z" fill="currentColor"/>
            </svg>
            </a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/v5.2.0">Interchain Security Docs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/v5.2.0/introduction/overview">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/v5.2.0/upgrading/migrate_v4_v5">Upgrading</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/v5.2.0/features/key-assignment">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/v5.2.0/consumer-development/app-integration">Consumer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interchain-security/v5.2.0/validators/overview">Validators Guide</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interchain-security/v5.2.0/faq">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/interchain-security/v5.2.0/adrs/intro">ADRs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/intro">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-004-denom-dos-fixes">Denom DOS fixes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-007-pause-unbonding-on-eqv-prop">Pause validator unbonding during equivocation proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-001-key-assignment">Key Assignment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-002-throttle">Jail Throttling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-003-equivocation-gov-proposal">Equivocation governance proposal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-005-cryptographic-equivocation-verification">Cryptographic verification of equivocation evidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-008-throttle-retries">Throttle with retries</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-009-soft-opt-out">Soft Opt-Out</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-010-standalone-changeover">Standalone to Consumer Changeover</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-011-improving-test-confidence">Improving testing and increasing confidence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-012-separate-releasing">Separate Releasing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-013-equivocation-slashing">Slashing on the provider for consumer equivocation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-014-epochs">Epochs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-015-partial-set-security">Partial Set Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-016-securityaggregation">Security aggregation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interchain-security/v5.2.0/adrs/adr-017-allowing-inactive-validators">ICS with Inactive Provider Validators</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Interchain Security<!-- --> <b>v5.2.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/interchain-security/adrs/adr-015-partial-set-security">latest version</a></b> (<!-- -->Next<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interchain-security/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ADRs</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Partial Set Security</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v5.2.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 015: Partial Set Security</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog">​</a></h2>
<ul>
<li>2024-01-22: Proposed, first draft of ADR.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2>
<p>Accepted</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2>
<p>Currently, in <em>Replicated Security</em>, the entire validator set of the provider chain is used to secure consumer chains. There are at least three concerns with this approach.
First, a large number of validators might be forced to validate consumer chains they are not interested in securing.
Second, it is costly for small validators to secure additional chains. This concern is only partially addressed through <a href="https://github.com/cosmos/interchain-security/blob/main/docs/docs/adrs/adr-009-soft-opt-out.md" target="_blank" rel="noopener noreferrer">soft opt-out</a> that allows small validators to opt out from validating consumer chains.
Third and for the above reasons, it is challenging for a new consumer chain to join Replicated Security.</p>
<p>As a solution, we present <em>Partial Set Security</em> (PSS). As the name suggests, PSS allows for every consumer chain to be secured by only a subset of the provider validator set.
In what follows we propose the exact steps we need to take to implement PSS. This is a first iteration of PSS, and therefore we present the most minimal solution that make PSS possible.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2>
<p>In Replicated Security, all the provider validators have to secure every consumer chain (with the exception of those validators allowed to opt out through the <a href="https://github.com/cosmos/interchain-security/blob/main/docs/docs/adrs/adr-009-soft-opt-out.md" target="_blank" rel="noopener noreferrer">soft opt-out</a> feature).</p>
<p>In PSS, we allow validators to opt in and out of validating any given consumer chain.
This has one exception:  we introduce a parameter <code>N</code> for each consumer chain and require that the validators in top <code>N%</code> of the provider&#x27;s voting power have to secure the consumer chain.
Validators outside of the top <code>N%</code> can dynamically opt in if they want to validate on the consumer chain.</p>
<p>For example, if a consumer chain has <code>N = 95%</code>, then it ultimately receives the same security it receives today with Replicated Security (with a default <a href="https://github.com/cosmos/interchain-security/blob/main/docs/docs/adrs/adr-009-soft-opt-out.md" target="_blank" rel="noopener noreferrer">SoftOptOutThreshold</a> of 5%).
On the other hand, if a consumer chain has <code>N = 0%</code>, then no validator is forced to validate the chain, but validators can opt in to do so instead.</p>
<p>For the remainder of this ADR, we call a consumer chain <em>Top N</em> if it has joined as a Top N chain with <code>N &gt; 0</code> and <em>Opt In</em> chain otherwise.  An Opt In consumer chain is secured only by the validators that have opted in to secure that chain.</p>
<p>We intend to implement PSS using a feature branch off <a href="https://github.com/cosmos/interchain-security/tree/v4.0.0" target="_blank" rel="noopener noreferrer">v4.0.0 interchain security</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-consumer-chains-join">How do consumer chains join?<a href="#how-do-consumer-chains-join" class="hash-link" aria-label="Direct link to How do consumer chains join?" title="Direct link to How do consumer chains join?">​</a></h3>
<p>As a simplification and to avoid <a href="https://forum.cosmos.network/t/pss-permissionless-vs-premissioned-lite-opt-in-consumer-chains/12984/17" target="_blank" rel="noopener noreferrer">chain id squatting</a>, a consumer chain can only join PSS through a governance proposal and not in a permissionless way.</p>
<p>However, this proposal type will be modified so that it requires a lower quorum percentage than normal proposal, and every validator who voted &quot;YES&quot; on the proposal will form the consumer chain&#x27;s initial validator set.</p>
<p>Consumer chains join PSS the same way chains now join Replicated Security, namely through a <code>ConsumerAdditionProposal</code> proposal.
We extend <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/proto/interchain_security/ccv/provider/v1/provider.proto#L27" target="_blank" rel="noopener noreferrer"><code>ConsumerAdditionProposal</code></a> with one optional field:</p>
<p><code>uint32 top_N</code>: Corresponds to the percentage of validators that join under the Top N case.
For example, <code>53</code> corresponds to a Top 53% chain, meaning that the top <code>53%</code> provider validators have to validate the proposed consumer chain.
<code>top_N</code>  can be <code>0</code> or include any value in <code>[50, 100]</code>. A chain can join with <code>top_N == 0</code> as an Opt In, or with <code>top_N ∈ [50, 100]</code> as a Top N chain.</p>
<p>In case of a Top N chain, we restrict the possible values of <code>top_N</code> from <code>(0, 100]</code> to <code>[50, 100]</code>.
By having <code>top_N &gt;= 50</code> we can guarantee that we cannot have a successful attack, assuming that at most <code>1/3</code> of provider validators can be malicious.
This is because, a Top N chain with <code>N &gt;= 50%</code> would have at least <code>1/3</code> honest validators, which is sufficient to stop attacks.
Additionally, by having <code>N &gt;= 50%</code> (and hence <code>N &gt; (VetoThreshold = 33.4%)</code>) we enable the top N validators to <code>Veto</code> any <code>ConsumerAdditionProposal</code> for consumer chains they do not want to validate.</p>
<p>If a proposal has the <code>top_N</code> argument wrongly set, it should get rejected in [ValidateBasic] (<a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/types/proposal.go#L86" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/types/proposal.go#L86</a>).</p>
<p>In the code, we distinguish whether a chain is <em>Top N</em> or <em>Opt In</em> by checking whether <code>top_N</code> is zero or not.</p>
<p>In a future version of PSS, we intend to introduce a <code>ConsumerModificationProposal</code> so that we can modify the parameters of a consumer chain, e.g, a chain that is <em>Opt In</em> to become <em>Top N</em>, etc.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="state--query">State &amp; Query<a href="#state--query" class="hash-link" aria-label="Direct link to State &amp; Query" title="Direct link to State &amp; Query">​</a></h4>
<p>We augment the provider module’s state to keep track of the <code>top_N</code> value for each consumer chain. The key to store this information would be:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">topNBytePrefix | len(chainID) | chainID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To create the above key, we can use <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/types/keys.go#L418" target="_blank" rel="noopener noreferrer"><code>ChainIdWithLenKey</code></a>.</p>
<p>Then in the <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/keeper/keeper.go" target="_blank" rel="noopener noreferrer">keeper</a> we introduce methods as follows:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (k Keeper) SetTopN(ctx sdk.Context, chainID string, topN uint32)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (k Keeper) IsTopN(ctx sdk.Context, chainID string) bool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (k Keeper) IsOptIn(ctx sdk.Context, chainID string) bool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// returns the N if Top N chain, otherwise an error</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (k Keeper) GetTopN(ctx sdk.Context, chainID string) (uint32, error)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We also extend the <code>interchain-security-pd query provider list-consumer-chains</code> query to return information on whether a consumer chain is an Opt In or a Top N chain and with what N.
This way, block explorers can present informative messages such as &quot;This chain is secured by N% of the provider chain&quot; for consumer chains.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-validators-opt-in">How do validators opt in?<a href="#how-do-validators-opt-in" class="hash-link" aria-label="Direct link to How do validators opt in?" title="Direct link to How do validators opt in?">​</a></h3>
<p>A validator can opt in by sending a new type of message that we introduce in <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/proto/interchain_security/ccv/provider/v1/tx.proto#L1" target="_blank" rel="noopener noreferrer">tx.proto</a>.</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">message</span><span class="token plain"> </span><span class="token class-name">MsgOptIn</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// the chain id of the consumer chain to opt in to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> chainID </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// the provider address of the validator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> providerAddr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// (optional) the consensus public key to use on the consumer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">optional</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> consumerKey </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that in a Top N consumer chain, the top <code>N%</code> provider validators have to validate the consumer chain.
Nevertheless, validators in the bottom <code>(100 - N)%</code> can opt in to validate as well.
Provider validators that belong or enter the top <code>N%</code> validators are <em>automatically</em> opted in to validate a Top N consumer chain.
This means that if a validator <code>V</code> belongs to the top <code>N%</code> validators but later falls (e.g., due to undelegations) to the bottom <code>(100 - N)%</code>, <code>V</code> is still considered opted in and has to validate unless <code>V</code> sends a <code>MsgOptOut</code> message (see below).
By automatically opting in validators when they enter the top <code>N%</code> validators and by forcing top <code>N%</code> validators to explicitly opt out in case they fall to the <code>(100 - N)%</code> bottom validators we simplify the design of PSS.</p>
<p>Note that a validator can send a <code>MsgOptIn</code> message even if the consumer chain is not yet running. To do this we reuse the <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/keeper/key_assignment.go#L644" target="_blank" rel="noopener noreferrer"><code>IsConsumerProposedOrRegistered</code></a>. If the <code>chainID</code> does not exist, the <code>MsgOptIn</code> should fail, as well as if the provider address does not exist.</p>
<p>Optionally, a validator that opts in can provide a <code>consumerKey</code> so that it assigns a different consumer key (from the provider) to the consumer chain.
Naturally, a validator can always change the consumer key on a consumer chain by sending a <code>MsgAssignConsumerKey</code> message at a later point in time, as is done in Replicated Security.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="state--query-1">State &amp; Query<a href="#state--query-1" class="hash-link" aria-label="Direct link to State &amp; Query" title="Direct link to State &amp; Query">​</a></h4>
<p>For each validator, we store a pair <code>(blockHeight, isOptedIn)</code> that contains the block height the validator opted in and whether the validator is currently opted in or not, under the key:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">optedInBytePrefix | len(chainID) | chainID | addr</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By using a prefix iterator on <code>optedInBytePrefix | len(chainID) | chainID</code> we retrieve all the opted in validators.</p>
<p>We introduce the following <code>Keeper</code> methods.</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// returns all the validators that have opted in on chain `chainID`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (k Keeper) GetOptedInValidators(ctx sdk.Context, chainID string) []Validators</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (k Keeper) IsValidatorOptedIn(ctx sdk.Context, chainID string, val Validator) bool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We introduce the following two queries:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">interchain-security-pd query provider optedInValidators $chainID</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">interchain-security-pd query provider hasToValidate $providerAddr</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>One query to retrieve the validators that are opted in and hence the validators that need to validate the consumer chain and one query that given a validator&#x27;s address returns all the chains this validator has to validate.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-do-validators-opt-in">When do validators opt in?<a href="#when-do-validators-opt-in" class="hash-link" aria-label="Direct link to When do validators opt in?" title="Direct link to When do validators opt in?">​</a></h4>
<p>As described earlier, validators can manually opt in by sending a <code>MsgOptIn</code> message.
Additionally, in a Top N chain, a validator is automatically opted in when it moves from the bottom <code>(100 - N)%</code> to the top <code>N%</code> validators.</p>
<p>Lastly, validators can also opt in if they vote <code>Yes</code> during the <code>ConsumerAdditionProposal</code> that introduces a consumer chain.
This simplifies validators operations because they do not have to send an additional message to opt in.</p>
<p>Because the <code>Tally</code> method <a href="https://github.com/cosmos/cosmos-sdk/blob/v0.47.7/x/gov/keeper/tally.go#L71" target="_blank" rel="noopener noreferrer">deletes the votes</a> after reading them, we cannot check the votes of the validators after the votes have been tallied.
To circumvent this, we introduce a hook for <a href="https://github.com/cosmos/cosmos-sdk/blob/v0.47.7/x/gov/keeper/vote.go#L35" target="_blank" rel="noopener noreferrer"><code>AfterProposalVote</code></a> and keep track of all the votes cast by a validator.
If a validator casts more than one vote, we only consider the latest vote.
Finally, we only consider a validator has opted in if it casts a 100% <code>Yes</code> vote in case of a <a href="https://github.com/cosmos/cosmos-sdk/blob/main/docs/architecture/adr-037-gov-split-vote.md" target="_blank" rel="noopener noreferrer">weighted vote</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-validators-opt-out">How do validators opt out?<a href="#how-do-validators-opt-out" class="hash-link" aria-label="Direct link to How do validators opt out?" title="Direct link to How do validators opt out?">​</a></h3>
<p>Validators that have opted in on a chain can opt out by sending the following message:</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">message</span><span class="token plain"> </span><span class="token class-name">MsgOptOut</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// the chain id of the consumer chain to opt out from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> chainID </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// the provider address of the validator</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> providerAddr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Validators can only opt out after a consumer chain has started and hence the above message returns an error if the chain with <code>chainID</code> is not running.
Additionally, a validator that belongs to the top <code>N%</code> validators cannot opt out from a Top N chain and hence a <code>MsgOptOut</code> would error in such a case.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="state--query-2">State &amp; Query<a href="#state--query-2" class="hash-link" aria-label="Direct link to State &amp; Query" title="Direct link to State &amp; Query">​</a></h4>
<p>We also update the state of the opted-in validators when a validator has opted out by removing the opted-out validator.</p>
<p>Note that only opted-in validators can be punished for downtime on a consumer chain.
For this, we use historical info of all the validators that have opted in; We can examine the <code>blockHeight</code> stored under the key <code>optedInBytePrefix | len(chainID) | chainID | addr</code> to see if a validator was opted in.
This way we can jail validators for downtime knowing that indeed the validators have opted in at some point in the past.
Otherwise, we can think of a scenario where a validator <code>V</code> is down for a period of time, but before <code>V</code> gets punished for downtime, validator <code>V</code> opts out, and then we do not know whether <code>V</code> should be punished or not.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="when-does-a-consumer-chain-start">When does a consumer chain start?<a href="#when-does-a-consumer-chain-start" class="hash-link" aria-label="Direct link to When does a consumer chain start?" title="Direct link to When does a consumer chain start?">​</a></h3>
<p>A Top N consumer chain always starts at the specified date (<code>spawn_time</code>) if the <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/proto/interchain_security/ccv/provider/v1/provider.proto#L27" target="_blank" rel="noopener noreferrer"><code>ConsumerAdditionProposal</code></a> has passed.
An Opt In consumer chain only starts if at least one validator has opted in. We check this in <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/keeper/proposal.go#L357" target="_blank" rel="noopener noreferrer">BeginBlockInit</a>:</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">func (k Keeper) BeginBlockInit(ctx sdk.Context) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    propsToExecute := k.GetConsumerAdditionPropsToExecute(ctx)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    for _, prop := range propsToExecute {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        chainID := prop.ChainId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if !k.IsTopN(ctx, chainID) &amp;&amp; len(k.GetOptedInValidators(ctx, chainID)) == 0 {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            // drop the proposal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ctx.Logger().Info(&quot;could not start chain because no validator has opted in&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            continue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-we-send-the-partial-validator-sets-to-the-consumer-chains">How do we send the partial validator sets to the consumer chains?<a href="#how-do-we-send-the-partial-validator-sets-to-the-consumer-chains" class="hash-link" aria-label="Direct link to How do we send the partial validator sets to the consumer chains?" title="Direct link to How do we send the partial validator sets to the consumer chains?">​</a></h3>
<p>A consumer chain should only be validated by opted in validators.
We introduce logic to do this when we <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/keeper/relay.go#L213" target="_blank" rel="noopener noreferrer">queue</a> the <code>VSCPacket</code>s.
The logic behind this, is not as straightforward as it seems because CometBFT does not receive the validator set that has to validate a chain, but rather a delta of <a href="https://docs.cometbft.com/v0.37/spec/abci/abci++_methods#validatorupdate" target="_blank" rel="noopener noreferrer">validator updates</a>.
For example, to remove an opted-out validator from a consumer chain, we have to send a validator update with a <code>power</code> of <code>0</code>, similarly to what is done in the <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/keeper/key_assignment.go#L525" target="_blank" rel="noopener noreferrer">assignment of consumer keys</a>.
We intend to update this ADR at a later stage on how exactly we intend to implement this logic.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-we-distribute-rewards">How do we distribute rewards?<a href="#how-do-we-distribute-rewards" class="hash-link" aria-label="Direct link to How do we distribute rewards?" title="Direct link to How do we distribute rewards?">​</a></h3>
<p>Currently, rewards are distributed as follows: The consumer <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/consumer/keeper/distribution.go#L148" target="_blank" rel="noopener noreferrer">periodically sends rewards</a> on the provider <code>ConsumerRewardsPool</code> address.
The provider then <a href="https://github.com/cosmos/interchain-security/blob/v4.0.0/x/ccv/provider/keeper/distribution.go#L77" target="_blank" rel="noopener noreferrer">transfers those rewards to the fee collector address</a> and those transferred rewards are distributed to validators and delegators.</p>
<p>In PSS, we distribute rewards only to validators that actually validate the consumer chain.
To do this, we have a pool associated with each consumer chain and consumers IBC transfer the rewards to this pool.
We then extract the rewards from each consumer pool and distribute them to the opted in validators.</p>
<p>Note that we only distribute rewards to validators that have been opted in for some time (e.g., 10000 blocks) to avoid cases where validators opt in just to receive rewards and then opt out immediately afterward.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="misbehaviour">Misbehaviour<a href="#misbehaviour" class="hash-link" aria-label="Direct link to Misbehaviour" title="Direct link to Misbehaviour">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="fraud-votes">Fraud votes<a href="#fraud-votes" class="hash-link" aria-label="Direct link to Fraud votes" title="Direct link to Fraud votes">​</a></h4>
<p>In an Opt In chain, a set of validators might attempt to perform an attack. To deter such potential attacks, PSS allows for the use of fraud votes.
A <em>fraud vote</em> is a governance proposal that enables the slashing of validators that performed an attack.
Due to their inherent complexity, we intend to introduce fraud votes in a different ADR and at a future iteration of PSS.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="double-signing">Double signing<a href="#double-signing" class="hash-link" aria-label="Direct link to Double signing" title="Direct link to Double signing">​</a></h4>
<p>We do not change the way slashing for double signing and light client attacks functions.
If a validator misbehaves on a consumer, then we slash that validator on the provider.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="downtime">Downtime<a href="#downtime" class="hash-link" aria-label="Direct link to Downtime" title="Direct link to Downtime">​</a></h4>
<p>We do not change the way downtime jailing functions.
If a validator is down on a consumer chain for an adequate amount of time, we jail this validator on the provider but only if the validator was opted in on this consumer chain in the recent past.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive">​</a></h3>
<ul>
<li>
<p>Easier for new consumer chains to consume the provider&#x27;s chain economic security because proposals are more likely to pass if not everyone is forced to validate.</p>
</li>
<li>
<p>Smaller validators are not forced to validate chains anymore if they do not want to.</p>
</li>
<li>
<p>We can deprecate the soft opt-out implementation.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative">​</a></h3>
<ul>
<li>A consumer chain does not receive the same economic security as with Replicated Security (assuming the value of <code>SoftOptOutThreshold</code> is <code>5%</code>), unless it is a Top N chain with <code>N &gt;= 95%</code>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://forum.cosmos.network/t/pss-permissionless-vs-premissioned-lite-opt-in-consumer-chains/12984" target="_blank" rel="noopener noreferrer">PSS: Permissionless vs premissioned-lite opt-in consumer chains</a></li>
<li><a href="https://forum.cosmos.network/t/chips-discussion-phase-partial-set-security-updated/11775" target="_blank" rel="noopener noreferrer">CHIPs discussion phase: Partial Set Security (updated)</a></li>
<li><a href="https://forum.cosmos.network/t/pss-exclusive-vs-inclusive-top-n/13058" target="_blank" rel="noopener noreferrer">PSS: Exclusive vs Inclusive Top-N</a></li>
<li><a href="https://github.com/cosmos/interchain-security/pull/1518" target="_blank" rel="noopener noreferrer">Initial PSS ADR and notes #1518</a></li>
<li><a href="https://informal.systems/blog/replicated-vs-mesh-security" target="_blank" rel="noopener noreferrer">Replicated vs. Mesh Security</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/interchain-security/v5.2.0/adrs/adr-014-epochs"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Epochs</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/interchain-security/v5.2.0/adrs/adr-016-securityaggregation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Security aggregation</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#how-do-consumer-chains-join" class="table-of-contents__link toc-highlight">How do consumer chains join?</a></li><li><a href="#how-do-validators-opt-in" class="table-of-contents__link toc-highlight">How do validators opt in?</a></li><li><a href="#how-do-validators-opt-out" class="table-of-contents__link toc-highlight">How do validators opt out?</a></li><li><a href="#when-does-a-consumer-chain-start" class="table-of-contents__link toc-highlight">When does a consumer chain start?</a></li><li><a href="#how-do-we-send-the-partial-validator-sets-to-the-consumer-chains" class="table-of-contents__link toc-highlight">How do we send the partial validator sets to the consumer chains?</a></li><li><a href="#how-do-we-distribute-rewards" class="table-of-contents__link toc-highlight">How do we distribute rewards?</a></li><li><a href="#misbehaviour" class="table-of-contents__link toc-highlight">Misbehaviour</a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cosmos.network"><img src="/interchain-security/img/logo-bw.svg" alt="Interchain Security Logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hub.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.tendermint.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tendermint Core<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ibc.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/cosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cosmosproject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">The development of Interchain Security is primarily led by Informal Systems. Funding for this development comes primarily from the Interchain Foundation, a Swiss non-profit.</div></div></div></footer></div>
</body>
</html>